<!DOCTYPE html>
<html lang="zh-cn">

<head>

<title>svg 流程图</title>
<meta charset="utf-8" />

<style type="text/css">
body {
	font-family: "Noto Sans CJK SC", "Microsoft Yahei", Kaiti, Songti, serif, sans-serif;
	font-size: 0.87em;
	margin: 5%;
	background: #eeee99; /* yellow */
}

svg {
	stroke: black;
	fill: none;
	width: 100%;
}

svg text {
	stroke: none;
	fill: black;
}

svg path.arrow {
	marker-end: url(#arrow-end);
}

svg path.double-arrow {
	marker-start: url(#arrow-start);
	marker-end: url(#arrow-end);
}

svg path.dashed {
	stroke-dasharray: 5, 5;
}

textarea {
	width: 100%;
	height: 250px;
	font-size: 1em;
	margin-bottom: 10px;
}
</style>

</head>

<body>

<textarea id="code">
newNode([
	{name:'a', text:'开始', type:Rect, args:{roundCorner:10}},
	{name:'b', text:'i < n?', type:Diamond},
	{name:'c', text:'结束', type:Rect, args:{roundCorner:10}},
]);

newLine([
	{from:'a', to:'b'},
	{from:'b', to:'c'},
]);
</textarea>

<div id="source" hidden><svg height="200px" width="100%"></svg></div>

<script>
'use strict';
function draw_svg() {
var source = document.getElementById("source");
var flowchart = source.firstChild;
var margin = 5, sep = 20;
var x = margin, y = margin;
var nodes = [];
var name_table = {};

function setAttrs(elem, dict) {
	for (var attr in dict) {
		if (!elem.getAttribute(attr))
			elem.setAttribute(attr, dict[attr]);
	}
}

// x,y 是中心坐标, hw 是宽度一半, hh 是高度一半
function Rect(args) {
	this.hw = (args.width+30)/2 || 40;
	this.hh = (args.height+10)/2 || 15;
	this.roundCorner = args.roundCorner;
}

Rect.prototype.draw = function() {
	var rect = document.createElement('rect');
	this.x = x-this.hw;
	this.y = y;
	setAttrs(rect, {
		x: x-this.hw,
		y: y,
		width: 2*this.hw,
		height: 2*this.hh,
		rx: this.roundCorner,
		ry: this.roundCorner
	});
	flowchart.appendChild(rect);
}

function Parallelogram(args) {
	this.hw = (args.width+35)/2 || 40;
	this.hh = (args.height+10)/2 || 15;
	this.offset = args.offset || 7;
}

Parallelogram.prototype.draw = function() {
	var para = document.createElement('polygon');
	this.x = x-this.hw;
	this.y = y;
	setAttrs(para, {
		points: this.offset + ',0 '
			+ (2*this.hw+this.offset) + ',0 '
			+ (2*this.hw-this.offset) + ',' + 2*this.hh + ' '
			+ -this.offset + ',' + 2*this.hh,
		transform: 'translate(' + (x-this.hw) + ',' + y + ')'
	});
	flowchart.appendChild(para);
}

function Diamond(args) {
	this.hw = (args.width+40)/2 || 50;
	this.hh = (args.height+20)/2 || 40;
}

Diamond.prototype.draw = function() {
	var diam = document.createElement('polygon');
	this.x = x-this.hw;
	this.y = y;
	setAttrs(diam, {
		points: this.hw + ',0 '
			+ 2*this.hw + ',' + this.hh + ' '
			+ this.hw + ',' + 2*this.hh + ' '
			+ '0,' + this.hh,
		transform: 'translate(' + (x-this.hw) + ',' + y + ')'
	});
	flowchart.appendChild(diam);
}

function Node(params) {
	this.type = params.type;
	this.name = params.name;
	this.text = document.createElement('text');
	this.text.innerHTML = params.text || ' ';
	document.body.appendChild(this.text);
	var rect = this.text.getBoundingClientRect();
	if (params.args === undefined)
		params.args = {};
	params.args.width = rect.width;
	params.args.height = rect.height;
	this.shape = new params.type(params.args);
	if (x-margin < this.shape.hw)
		x = this.shape.hw+margin;
}

Node.prototype.draw = function() {
	this.shape.draw();
	var rect = this.text.getBoundingClientRect();
	setAttrs(this.text, {
		x: x-rect.width/2,
		y: y+rect.height/2+this.shape.hh-margin
	});
	flowchart.appendChild(this.text);
	y += sep + 2*this.shape.hh;
}

function newNode(params) {
	for (var i = 0; i < params.length; ++i) {
		nodes.push(new Node(params[i]));
		name_table[params[i].name] = i;
	}
	for (var i = 0; i < nodes.length; ++i) {
		nodes[i].draw();
	}
}

function Line(params) {
	var line = document.createElement('path');
	var from = nodes[name_table[params.from]].shape;
	var to = nodes[name_table[params.to]].shape;
	var fx = from.x + from.hw;
	var fy = from.y + 2*from.hh;
	var tx = to.x + to.hw;
	var ty = to.y;

	setAttrs(line, {
		class: 'arrow',
		d: 'M ' + fx + ',' + fy + 'L ' + tx + ',' + ty
	});
	flowchart.appendChild(line);
}

function newLine(params) {
	for (var i = 0; i < params. length; ++i) {
		new Line(params[i]);
	}
}

var code = document.getElementById("code");
eval(code.innerHTML);
document.write(source.innerHTML);
document.write('<textarea>'
	+ source.innerHTML.replace(/</g, '&lt;').replace(/>/g, '&gt;')
	+ '</textarea>'
);
}
draw_svg();
</script>
</body>

</html>
